#!/usr/bin/env bash

for_install=0
if [[ -n "$1" ]] && [[ "$1" == "--for-install" ]]; then
    for_install=1
fi

# we don't want the uninstall script to be able to cause a failure if being triggered by the setup script
[ "$for_install" -eq 0 ] && set -e

if command -v qdbus >/dev/null 2>&1; then
  QDBUS_CMD=$(command -v qdbus)
elif command -v qdbus6 >/dev/null 2>&1; then
  QDBUS_CMD=$(command -v qdbus6)
fi

if [ -n "$QDBUS_CMD" ]; then
  if $QDBUS_CMD org.kde.KWin /Effects org.kde.kwin.Effects.unloadEffect breezy_desktop; then
    [ "$for_install" -eq 0 ] && echo "Unloaded breezy_desktop effect"
  fi
fi

USER_HOME=$(realpath ~)
if [ "$for_install" -eq 0 ]; then
    UA_EVENT_NAME="breezy_kwin_uninstall"
    UA_CLIENT_ID="BreezyKWin"
    #INJECT_UA_CALL
fi

if [ -z "$XDG_BIN_HOME" ]; then
  XDG_BIN_HOME="$USER_HOME/.local/bin"
fi

if [ -z "$XDG_DATA_HOME" ]; then
  XDG_DATA_HOME="$USER_HOME/.local/share"
fi

if [ -z "$LIB_HOME" ]; then
  LIB_HOME="$USER_HOME/.local/lib"
fi

EFFECT_ID="breezy_desktop"
EFFECT_DIR="$XDG_DATA_HOME/kwin/effects/$EFFECT_ID"
PLUGIN_SO="$LIB_HOME/qt6/plugins/kwin/effects/plugins/${EFFECT_ID}.so"
CONFIG_SO="$LIB_HOME/qt6/plugins/kwin/effects/configs/${EFFECT_ID}_config.so"
BREEZY_LIBRARY_DIR="$LIB_HOME/breezy_kwin"

if [[ -d "$EFFECT_DIR" ]]; then
    [ "$for_install" -eq 0 ] && echo "Removing $EFFECT_DIR and its contents"
    $SUDO rm -rf "$EFFECT_DIR"
fi

if [[ -f "$PLUGIN_SO" ]]; then
    [ "$for_install" -eq 0 ] && echo "Removing $PLUGIN_SO"
    $SUDO rm -f "$PLUGIN_SO"
fi

if [[ -f "$CONFIG_SO" ]]; then
    [ "$for_install" -eq 0 ] && echo "Removing $CONFIG_SO"
    $SUDO rm -f "$CONFIG_SO"
fi

if [[ -d "$BREEZY_LIBRARY_DIR" ]]; then
    [ "$for_install" -eq 0 ] && echo "Removing $BREEZY_LIBRARY_DIR and its contents"
    $SUDO rm -rf "$BREEZY_LIBRARY_DIR"
fi

if [[ -e "$XDG_BIN_HOME/xr_driver_uninstall" && "$for_install" -eq 0 ]]; then
  echo "Uninstalling XRLinuxDriver"
  sudo "$XDG_BIN_HOME/xr_driver_uninstall"
fi

# this script is self-deleting, leave this as the last command
rm -f $XDG_BIN_HOME/breezy_kwin_uninstall