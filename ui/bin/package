#!/usr/bin/env bash

# exit when any command fails
set -e

ARCH=${ARCH:-$(uname -m)}
echo "Building Breezy UI for $ARCH"

BUILD_PATH=build
UI_BUILD_PATH=$BUILD_PATH/ui
PACKAGE_DIR=$BUILD_PATH/breezy_ui
mkdir -p $UI_BUILD_PATH
mkdir -p $PACKAGE_DIR

meson setup $UI_BUILD_PATH
pushd $UI_BUILD_PATH
meson compile
popd

PACKAGE_SRC_DIR=$PACKAGE_DIR/src
PACKAGE_BIN_DIR=$PACKAGE_DIR/bin
PACKAGE_ICONS_DIR=$PACKAGE_DIR/icons
mkdir -p $PACKAGE_SRC_DIR
mkdir -p $PACKAGE_BIN_DIR
mkdir -p $PACKAGE_ICONS_DIR

cp src/*.py $PACKAGE_SRC_DIR
cp -r po $BUILD_PATH
cp modules/PyXRLinuxDriverIPC/xrdriveripc.py $PACKAGE_SRC_DIR
cp $UI_BUILD_PATH/src/breezydesktop $PACKAGE_BIN_DIR
cp $UI_BUILD_PATH/src/breezydesktop.gresource $PACKAGE_DIR
cp $UI_BUILD_PATH/data/com.xronlinux.BreezyDesktop.desktop $PACKAGE_DIR

rsvg-convert data/icons/hicolor/scalable/apps/com.xronlinux.BreezyDesktop.svg -w 64 -h 64 -o $PACKAGE_ICONS_DIR/com.xronlinux.BreezyDesktop_64.png
rsvg-convert data/icons/hicolor/scalable/apps/com.xronlinux.BreezyDesktop.svg -w 128 -h 128 -o $PACKAGE_ICONS_DIR/com.xronlinux.BreezyDesktop_128.png
rsvg-convert data/icons/hicolor/scalable/apps/com.xronlinux.BreezyDesktop.svg -w 256 -h 256 -o $PACKAGE_ICONS_DIR/com.xronlinux.BreezyDesktop_256.png
rsvg-convert data/icons/hicolor/scalable/apps/com.xronlinux.BreezyDesktop.svg -w 1024 -h 1024 -o $PACKAGE_ICONS_DIR/com.xronlinux.BreezyDesktop_1024.png

pushd $BUILD_PATH

tar -zcvf breezyUI-$ARCH.tar.gz breezy_ui

popd

mkdir -p out
cp $BUILD_PATH/breezyUI-$ARCH.tar.gz out/

rm -rf $BUILD_PATH